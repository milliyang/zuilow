version: '3.8'

services:
  dms:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: dms
    ports:
      - "${DMS_PORT:-11183}:11183"
    volumes:
      - ../config:/app/dms/config:ro
      - ../data:/app/dms/data
      - ../run:/app/dms/run
    environment:
      - DMS_HOST=${DMS_HOST:-0.0.0.0}
      - DMS_PORT=${DMS_PORT:-11183}
      - DMS_LOG_LEVEL=${DMS_LOG_LEVEL:-INFO}
      - DMS_LOG_DIR=/app/dms/run/logs
      - DMS_API_KEY=${DMS_API_KEY:-}
      - SECRET_KEY=${SECRET_KEY:-dev-secret-change-in-production}
      - WAIT_FOR_INFLUXDB=true
      - INFLUXDB_HOST=influxdb
      - INFLUXDB_PORT=8086
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:11183/api/dms/status').read()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    # 如果使用外部 InfluxDB，注释掉下面的 depends_on 和 networks
    # 并添加 extra_hosts 以访问宿主机服务
    depends_on:
      influxdb:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - dms-network
    # 如果需要访问宿主机上的 InfluxDB，取消下面的注释
    # extra_hosts:
    #   - "host.docker.internal:host-gateway"

  # InfluxDB 1.x 服务（DMS 使用 InfluxDB 1.x API）
  # 如果使用外部 InfluxDB，可以注释掉整个 influxdb 服务
  # 或者使用 docker-compose.external-db.yml 配置
  influxdb:
    image: influxdb:1.8
    container_name: dms-influxdb
    # 如果端口被占用，可以修改端口或注释掉 ports 映射
    ports:
      - "${INFLUXDB_PORT:-8086}:8086"
    volumes:
      - influxdb-data:/var/lib/influxdb
    environment:
      - INFLUXDB_DB=${INFLUXDB_DB:-dms_data}
      - INFLUXDB_ADMIN_USER=${INFLUXDB_USERNAME:-admin}
      - INFLUXDB_ADMIN_PASSWORD=${INFLUXDB_PASSWORD:-admin123456}
      - INFLUXDB_HTTP_AUTH_ENABLED=${INFLUXDB_AUTH_ENABLED:-false}
    # 增加文件描述符限制，解决 "too many open files" 错误
    # InfluxDB 1.8 在处理大量数据分片时需要打开很多文件
    # Docker 默认限制为 1024，需要提升到 262144
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    healthcheck:
      test: ["CMD", "influx", "-host", "localhost", "-port", "8086", "-execute", "SHOW DATABASES"]
      interval: 60s
      timeout: 3s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - dms-network

volumes:
  influxdb-data:

networks:
  dms-network:
    driver: bridge
