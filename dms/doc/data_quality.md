# 数据质量保证

> DMS 的核心价值：**自动、智能、可靠** 的数据维护

## 一、自动恢复机制

### 1.1 网络中断自动恢复

**场景**：网络中断后恢复

**自动恢复流程**：
1. 自动检测：查询数据库最新日期
2. 计算缺失：计算需要获取的时间范围
3. 批量获取：一次性从数据源获取缺失数据
4. 自动写入：写入新记录（自动跳过周末和节假日）
5. 同步备份：自动同步到所有备份节点

**结果**：数据完全补齐，无需人工干预

### 1.2 日志监控

**关键日志信息**：
- ⚠️ 数据缺失警告（Gap: X days）
- 📅 获取的时间范围
- ✅ 实际写入的记录数和日期范围
- 📊 任务完成统计（成功率、记录数）

---

## 二、数据质量检查层级

### 2.1 第一层：数据获取验证

**功能**：
- 检查必需列（Open, High, Low, Close, Volume）
- 检查负值（价格和成交量不能为负）
- 检查空数据

**保证**：
- 数据结构完整
- 数值合理性
- 非空数据

### 2.2 第二层：数据清洗

**功能**：
- 去除重复时间戳（保留最新）
- 按时间排序
- 删除全空行

**保证**：
- 无重复记录
- 时间顺序正确
- 数据干净

### 2.3 第三层：增量去重

**功能**：
- 查询数据库最新日期
- 过滤已存在数据
- 仅写入新数据

**保证**：
- 无重复写入
- 数据连续性
- 幂等性（多次运行结果一致）

### 2.4 第四层：数据连续性检查

**功能**：
- 检测时间间隔过大的缺口
- 自动跳过周末（日线数据）
- 检测超过 7 天的异常缺口

**检测逻辑**：
- 检查相邻数据点的时间间隔
- 对于日线数据，自动跳过周末（周六、周日）
- 检测超过 7 天的异常缺口

---

## 三、智能特性

### 3.1 自动检测数据缺失

**分级告警**：
- 缺口 > 7 天：WARNING 级别（可能需要关注）
- 缺口 > 1 天：INFO 级别（正常情况）
- 缺口 ≤ 1 天：DEBUG 级别（无需关注）

### 3.2 智能日期范围计算

**功能**：
- 自动适应不同场景（首次/增量）
- 自动计算缺失范围
- 避免重复获取

**逻辑**：
- 有数据：从最后一天的下一天开始
- 无数据：获取配置的历史天数（默认5年）

### 3.3 详细的执行报告

**报告内容**：
- 成功率
- 写入记录数
- 成功的股票列表
- 失败的股票列表
- 总股票数

---

## 四、可靠性保证

### 4.1 多重重试机制

**Fetcher 层重试**：
- 默认重试 3 次
- 指数退避策略（1s, 2s, 4s）

**Writer 层容错**：
- 支持写入多个服务器
- 只要有一个成功就返回成功
- 失败服务器记录警告日志

### 4.2 错误隔离

**功能**：
- 单个股票失败不影响其他股票
- 完整的错误日志
- 明确的失败列表

### 4.3 数据完整性保证

**UTC 时间标准化**：
- 统一转换为 UTC 时区
- 确保时间一致性

**InfluxDB 唯一性**：
- 同一 `symbol` + `interval` + `time` 的数据点唯一
- 重复写入自动覆盖（不会产生重复记录）

---

## 五、实战场景

### 场景 1：网络中断 1 天

- 检测缺口：1 天
- 自动获取缺失数据
- 写入记录：1 条
- 耗时：< 5 秒

### 场景 2：网络中断 1 周

- 检测缺口：7 天
- 自动获取缺失数据
- 写入记录：5 条（跳过周末）
- 耗时：< 10 秒

### 场景 3：服务重启（中断 1 个月）

- 检测缺口：31 天
- 自动获取缺失数据
- 写入记录：22 条（跳过周末和节假日）
- 耗时：< 30 秒

---

## 六、监控和告警

### 6.1 日志级别

| 级别 | 场景 | 示例 |
|------|------|------|
| **ERROR** | 数据写入失败、所有重试失败 | `Failed to write US.AAPL` |
| **WARNING** | 数据缺口 >7天、验证失败 | `Data gap: 10 days` |
| **INFO** | 正常更新、同步完成 | `Updated: 5 records` |
| **DEBUG** | 无需更新、过滤重复 | `No update needed` |

### 6.2 关键指标

**任务执行结果包含**：
- 成功率
- 写入记录数
- 失败列表
- 执行时间（秒）

---

## 七、最佳实践

### ✅ 配置建议

**增量更新任务**：
- 设置合理的 cron 时间（市场收盘后 1 小时）
- 支持多个符号文件
- 启用自动同步备份

**定期验证任务**：
- 每周检查数据质量
- 检查最近 30 天数据

**月度全量同步**：
- 每月全量同步（修正历史数据）

---

## 八、核心价值总结

| 价值 | 实现方式 |
|------|---------|
| **自动** | 自动检测缺失、自动计算范围、自动补齐数据 |
| **智能** | 分级日志、详细报告、连续性检查 |
| **可靠** | 多重重试、错误隔离、数据去重 |

**结论**：DMS 确保无论何时何地发生中断，都能自动恢复到完整、准确、连续的数据状态，满足量化回测的严格要求！

---

## 相关文档

- [架构设计](architecture.md) - 系统架构和设计
- [同步策略](sync_strategy.md) - 同步机制详解
- [API 参考](api_reference.md) - HTTP API 接口
